# turnserver.conf — sovereign TURN/STUN server for skworld.io
#
# Documentation: https://github.com/coturn/coturn/wiki/turnserver
# Quick start:   coturn -c /etc/coturn/turnserver.conf
# Reload config: kill -HUP $(cat /var/run/turnserver.pid)
#
# After editing: validate with `turnadmin -P` before reloading.

# ── Network ───────────────────────────────────────────────────────────────────

# Primary UDP/TCP STUN/TURN port
listening-port=3478

# Alternative port (some NATs block 3478)
alt-listening-port=3479

# TLS TURN port (requires cert/pkey below)
tls-listening-port=5349
alt-tls-listening-port=5350

# Restrict to the public network interface.
# Comment out to listen on all interfaces (useful in Docker/VPS).
# listening-ip=0.0.0.0

# Your server's public IP address. Required when behind NAT.
# Uncomment and set this to your VPS/bare-metal public IP:
# external-ip=YOUR_PUBLIC_IP

# ── Identity ──────────────────────────────────────────────────────────────────

# Realm for TURN authentication. Must match the ICE server configuration in
# WebRTC clients and skcomm webrtc transport.
realm=turn.skworld.io

# Server name (used in some STUN responses)
server-name=turn.skworld.io

# ── HMAC Credentials ──────────────────────────────────────────────────────────
#
# Time-limited credentials generated by coturn's HMAC mechanism.
# WebRTC clients compute: credential = HMAC-SHA1(secret, timestamp:username)
#
# Generate a secure secret:
#   openssl rand -hex 32
#
# The same secret must be set in:
#   ~/.skcomm/config.yml → transports.webrtc.settings.turn_secret
#   Cloudflare Worker env → TURN_SECRET (if using worker-side ICE config)

use-auth-secret
static-auth-secret=CHANGE_ME_TO_A_RANDOM_SECRET_openssl_rand_hex_32

# ── Port Range ────────────────────────────────────────────────────────────────
#
# UDP relay ports for media/data. Open this range in your firewall:
#   ufw allow 49152:65535/udp
#   ufw allow 3478/udp
#   ufw allow 3478/tcp
#   ufw allow 5349/tcp

min-port=49152
max-port=65535

# ── TLS ───────────────────────────────────────────────────────────────────────
#
# Recommended for production. Get certs from Let's Encrypt:
#   certbot certonly --standalone -d turn.skworld.io
#
# Uncomment these after setting up certificates:
# cert=/etc/letsencrypt/live/turn.skworld.io/fullchain.pem
# pkey=/etc/letsencrypt/live/turn.skworld.io/privkey.pem
# cipher-list=ECDH+AESGCM:DH+AESGCM:ECDH+AES256:DH+AES256:ECDH+AES128:DH+AES:RSA+AESGCM:RSA+AES:!aNULL:!MD5:!DSS

# ── Logging ───────────────────────────────────────────────────────────────────

log-file=/var/log/coturn/turnserver.log
simple-log

# Verbose logging (enable for debugging; disable in production)
# verbose

# ── Security ──────────────────────────────────────────────────────────────────

# Add integrity fingerprints to STUN messages
fingerprint

# Prevent relay to loopback/private addresses (SSRF protection)
no-loopback-peers
no-multicast-peers

# Deny relay to RFC 1918 private ranges:
denied-peer-ip=10.0.0.0-10.255.255.255
denied-peer-ip=172.16.0.0-172.31.255.255
denied-peer-ip=192.168.0.0-192.168.255.255

# ── Session Lifetime ──────────────────────────────────────────────────────────

# How long a nonce is valid (seconds). Clients must refresh after this.
stale-nonce=600

# Maximum data channel (TURN channel) lifetime
channel-lifetime=3600

# Maximum permission lifetime
permission-lifetime=300

# ── Performance ───────────────────────────────────────────────────────────────

# Maximum number of simultaneous allocations per user
# max-allocate-timeout=60

# Process priority (lower = higher priority)
# proc-user=turnserver
# proc-group=turnserver

# ── Redis (optional, for multi-instance deployments) ─────────────────────────
#
# If running multiple coturn instances behind a load balancer,
# use Redis to share session state:
# redis-statsdb=redis://127.0.0.1:6379/0
# redis-userdb=redis://127.0.0.1:6379/1
